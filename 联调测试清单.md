# 前后端联调测试清单

## 📋 测试环境准备

### 前端配置检查
- [x] `utils/config.js` 中的 `baseURL` 已配置：`http://192.168.54.229:8080/lovetime`
- [ ] 确保后端服务已启动并运行在 `http://192.168.54.229:8080`
- [ ] 确保小程序开发工具已连接到后端服务（检查网络连通性）

### 登录状态检查
- [ ] 确保测试账号已登录（Token有效）
- [ ] 可以在控制台查看登录信息：`uni.getStorageSync('login_info')`

---

## 🔐 1. 情侣关系绑定功能测试

### 1.1 生成邀请码
**测试步骤：**
1. 打开小程序，进入"我们"页面
2. 点击"邀请另一半"按钮
3. 点击"生成邀请码"按钮

**预期结果：**
- ✅ 成功生成邀请码（显示6位字符串）
- ✅ 显示过期时间
- ✅ 控制台输出：
  ```
  🔗 [情侣关系API] 开始生成邀请码
  📍 请求地址: http://192.168.54.229:8080/lovetime/api/couple/invite/create
  📋 请求方法: POST
  ✅ [情侣关系API] 生成邀请码成功
  ```

**后端接口要求：**
```
POST /api/couple/invite/create
Headers: Authorization: Bearer {token}
Response: {
  success: true,
  message: "邀请码生成成功",
  data: {
    inviteCode: "ABC123",
    expireAt: "2024-01-16T10:30:00Z"
  }
}
```

**常见问题排查：**
- ❌ 401错误：检查Token是否有效，是否在请求头中携带
- ❌ 500错误：检查后端日志，查看错误详情
- ❌ 网络错误：检查baseURL是否正确，后端服务是否启动

---

### 1.2 验证邀请码（接受邀请流程）
**测试步骤：**
1. 使用账号A生成邀请码：`ABC123`
2. 在账号B中，通过分享链接或手动输入邀请码进入邀请页面
3. 页面自动验证邀请码

**预期结果：**
- ✅ 显示邀请方（账号A）的昵称和头像
- ✅ 显示"收到邀请"提示
- ✅ 控制台输出：
  ```
  🔗 [情侣关系API] 开始验证邀请码
  📍 请求地址: http://192.168.54.229:8080/lovetime/api/couple/invite/validate?code=ABC123
  📋 请求方法: GET
  ✅ [情侣关系API] 验证邀请码成功
  👤 发起方: 账号A的昵称
  ```

**后端接口要求：**
```
GET /api/couple/invite/validate?code=ABC123
Headers: Authorization: Bearer {token}
Response: {
  success: true,
  message: "邀请码有效",
  data: {
    code: "ABC123",
    creator: {
      userId: "user_123",
      nickName: "账号A昵称",
      avatarUrl: "头像URL",
      displayName: "显示昵称",
      displayAvatar: "显示头像"
    },
    expireAt: "2024-01-16T10:30:00Z"
  }
}
```

**常见问题排查：**
- ❌ 404错误 + "邀请码无效"：
  1. **邀请码不存在**：确认邀请码是否正确，是否在数据库中
  2. **邀请码已过期**：检查后端过期时间设置，邀请码有效期通常为24小时
  3. **邀请码已被使用**：如果后端只允许使用一次，确认是否已被其他用户使用
  4. **大小写问题**：前端已自动转换为大写，但需确认后端是否大小写敏感
  5. **后端接口问题**：检查后端日志，确认是否收到请求以及处理逻辑
- ❌ 400错误：检查邀请码格式是否正确（URL编码问题）
- ❌ 显示"邀请码无效"：检查后端验证逻辑，确认邀请码生成和验证的一致性

---

### 1.3 接受邀请（建立绑定关系）
**测试步骤：**
1. 在邀请页面看到邀请方信息后
2. 点击"接受邀请"按钮

**预期结果：**
- ✅ 显示"接受中..."状态
- ✅ 成功后跳转到"我们"页面
- ✅ "我们"页面显示对方信息和在一起天数
- ✅ 控制台输出：
  ```
  🔗 [情侣关系API] 开始接受邀请
  📍 请求地址: http://192.168.54.229:8080/lovetime/api/couple/bind/accept
  📋 请求方法: POST
  📤 请求参数: { inviteCode: "ABC123" }
  ✅ [情侣关系API] 接受邀请成功
  💑 关系ID: couple_123456
  👤 对方昵称: 账号A昵称
  ```

**后端接口要求：**
```
POST /api/couple/bind/accept
Headers: Authorization: Bearer {token}
Body: {
  inviteCode: "ABC123"
}
Response: {
  success: true,
  message: "绑定成功",
  data: {
    coupleId: "couple_123456",
    partnerInfo: {
      userId: "user_123",
      nickName: "对方昵称",
      avatarUrl: "头像URL",
      displayName: "显示昵称",
      displayAvatar: "显示头像"
    },
    bindTime: "2024-01-15T10:30:00Z"
  }
}
```

**常见问题排查：**
- ❌ 提示"已绑定其他用户"：检查后端是否允许重复绑定
- ❌ 提示"邀请码已过期"：检查过期时间逻辑
- ❌ 提示"不能绑定自己"：检查后端是否拦截自己邀请自己

---

### 1.4 查询绑定状态
**测试步骤：**
1. 已绑定状态下，进入"我们"页面
2. 页面自动调用查询接口

**预期结果：**
- ✅ 显示双人头像（自己和对方）
- ✅ 显示对方昵称
- ✅ 显示在一起天数
- ✅ 控制台输出：
  ```
  🔗 [情侣关系API] 开始查询绑定状态
  📍 请求地址: http://192.168.54.229:8080/lovetime/api/couple/status
  📋 请求方法: GET
  ✅ [情侣关系API] 查询绑定状态成功
  📊 绑定状态:
     - 是否已绑定: 是
     - 关系ID: couple_123456
     - 对方昵称: 对方昵称
  ```

**后端接口要求：**
```
GET /api/couple/status
Headers: Authorization: Bearer {token}
Response: {
  success: true,
  data: {
    isBound: true,
    coupleId: "couple_123456",
    partnerInfo: {
      userId: "user_789",
      nickName: "对方昵称",
      avatarUrl: "头像URL",
      displayName: "显示昵称",
      displayAvatar: "显示头像"
    },
    bindTime: "2024-01-15T10:30:00Z",
    role: "initiator"  // "initiator" 或 "acceptor"
  }
}
```

**未绑定状态返回：**
```
Response: {
  success: true,
  data: {
    isBound: false
  }
}
```

---

### 1.5 解绑关系
**测试步骤：**
1. 在邀请页面，已绑定状态下
2. 点击"解除关系"按钮
3. 确认解绑

**预期结果：**
- ✅ 显示"解绑中..."状态
- ✅ 成功后返回未绑定状态
- ✅ 控制台输出：
  ```
  🔗 [情侣关系API] 开始解绑关系
  📍 请求地址: http://192.168.54.229:8080/lovetime/api/couple/unbind
  📋 请求方法: POST
  ✅ [情侣关系API] 解绑关系成功
  ```

**后端接口要求：**
```
POST /api/couple/unbind
Headers: Authorization: Bearer {token}
Response: {
  success: true,
  message: "解绑成功"
}
```

---

## 📱 2. 微信分享功能测试

### 2.1 分享邀请链接
**测试步骤：**
1. 生成邀请码后
2. 点击右上角"..."按钮
3. 选择"转发"给好友

**预期结果：**
- ✅ 显示小程序卡片
- ✅ 卡片标题：邀请TA加入我们的甜蜜时光
- ✅ 点击卡片后，自动携带邀请码参数进入邀请页面

**分享参数格式：**
```
pages/invite/index?code=ABC123
```

---

## 🔍 3. 错误处理测试

### 3.1 网络错误
- [ ] 关闭后端服务，测试所有API调用是否显示友好错误提示
- [ ] 检查控制台是否有详细错误日志

### 3.2 Token失效
- [ ] 手动删除Token，测试API调用是否提示"登录已过期"
- [ ] 检查是否自动跳转到登录页

### 3.3 接口返回异常
- [ ] 测试后端返回非标准格式数据时，前端是否能正确处理
- [ ] 检查是否有兼容性处理（API中有多处兼容代码）

---

## 📊 4. 联调检查清单

### 前端检查项
- [x] API封装完整（`api/couple.js`）
- [x] 工具函数完整（`utils/couple.js`）
- [x] 页面功能完整（`pages/invite/index.vue`）
- [x] 配置正确（`utils/config.js`）
- [x] 日志输出完善（控制台可查看详细请求信息）
- [x] 错误处理完善（用户友好的错误提示）

### 后端检查项
- [ ] 所有接口已实现并部署
- [ ] 接口路径与前端配置一致
- [ ] 请求方法（GET/POST）正确
- [ ] 请求头验证（Authorization Bearer Token）已实现
- [ ] 返回数据格式符合前端预期
- [ ] 错误响应格式统一（`{ success: false, message: "错误信息" }`）

### 联调测试顺序建议
1. **先测试查询状态接口** - 最简单，确认通信正常
2. **再测试生成邀请码** - POST请求，确认Token传递正常
3. **然后测试验证邀请码** - GET请求带参数，确认参数传递正常
4. **最后测试接受邀请** - 完整流程，确认数据保存正常

---

## 🐛 常见问题及解决方案

### 问题1：控制台显示 401 Unauthorized
**原因：** Token无效或未传递
**解决：**
1. 检查 `uni.getStorageSync('login_info')` 中是否有token
2. 检查后端是否验证 `Authorization: Bearer {token}` 头
3. 尝试重新登录获取新Token

### 问题2：控制台显示 Network Error
**原因：** 后端服务未启动或网络不通
**解决：**
1. 检查后端服务是否运行在 `http://192.168.54.229:8080`
2. 在浏览器访问 `http://192.168.54.229:8080/lovetime/api/couple/status` 测试连通性
3. 检查防火墙设置

### 问题3：邀请码验证失败
**原因：** 邀请码不存在、已过期或已被使用
**解决：**
1. 检查后端邀请码存储逻辑
2. 检查过期时间计算
3. 检查是否允许同一邀请码多次使用

### 问题4：绑定后查询不到对方信息
**原因：** 后端返回数据结构不符合预期
**解决：**
1. 检查控制台输出的响应数据格式
2. 对照前端期望的格式（见上方接口要求）
3. 前端已做兼容处理，但最好后端返回统一格式

---

## ✅ 测试通过标准

- [ ] 所有API接口调用成功，返回预期数据
- [ ] 邀请码生成、验证、接受流程完整
- [ ] 微信分享功能正常，分享链接可携带邀请码
- [ ] 绑定状态查询正常，显示对方信息
- [ ] 解绑功能正常
- [ ] 错误处理友好，用户能看到明确提示
- [ ] 控制台日志清晰，便于问题排查

---

## 📞 联调联系

如果遇到问题，请检查：
1. **控制台日志** - 查看详细的请求和响应信息
2. **后端日志** - 查看后端接收到的请求数据
3. **网络面板** - 在微信开发者工具中查看Network请求详情

**提示：** 前端代码已包含详细的日志输出，所有API调用都会在控制台显示完整信息，便于排查问题。

