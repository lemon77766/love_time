# 微信授权登录流程图

## 🔄 完整登录流程

```
┌──────────────────────────────────────────────────────────────────────┐
│                         用户打开小程序                                 │
└────────────────────────────────┬─────────────────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │  pages/login/index.vue │
                    │   显示登录页面          │
                    └────────────┬───────────┘
                                 │
                                 ▼
                  用户点击"微信授权登录"按钮
                                 │
                                 ▼
        ┌────────────────────────────────────────────────┐
        │          【步骤1】调用 uni.login()            │
        │    前端 ──────────────────────> 微信服务器     │
        │              获取临时登录凭证 code              │
        │    前端 <────────────────────── 微信服务器     │
        │              返回 code (有效期5分钟)            │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────────┐
        │      【步骤2】调用 uni.getUserProfile()       │
        │               弹出授权窗口                     │
        │        用户点击"允许"授权                      │
        │      获取用户昵称(nickName)和头像(avatarUrl)   │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────────┐
        │  【步骤3】调用 api/login.js 中的 wxLogin()    │
        │  发送数据：                                    │
        │  {                                             │
        │    code: "081xYz0w...",                       │
        │    nickName: "微信用户",                       │
        │    avatarUrl: "https://..."                   │
        │  }                                             │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────────┐
        │    【步骤4】utils/http.js 发送 HTTP 请求       │
        │    POST {baseURL}/api/login/wechat            │
        │    请求头：Content-Type: application/json      │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────────┐
        │             【步骤5】后端处理                  │
        │  1. 接收 code + 用户信息                       │
        │  2. 用 AppID + AppSecret + code 调用微信接口   │
        │  3. 微信返回 openid + session_key             │
        │  4. 查询/创建用户记录                          │
        │  5. 生成 JWT Token                            │
        │  6. 返回给前端                                 │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────────┐
        │      【步骤6】前端接收后端返回的数据            │
        │  {                                             │
        │    success: true,                              │
        │    message: "登录成功",                        │
        │    data: {                                     │
        │      token: "eyJhbGciOiJIUzI1...",             │
        │      openid: "oABC123xyz...",                 │
        │      session_key: "HyVFkGl5F5..."             │
        │    }                                           │
        │  }                                             │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────────┐
        │   【步骤7】前端保存登录信息到本地存储           │
        │   uni.setStorageSync('login_info', {          │
        │     isLoggedIn: true,                          │
        │     token: "...",                              │
        │     openid: "...",                             │
        │     sessionKey: "...",                         │
        │     userInfo: { nickName, avatarUrl },         │
        │     loginTime: "2025-10-28T..."               │
        │   })                                           │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
        ┌────────────────────────────────────────────────┐
        │        【步骤8】显示"登录成功"提示             │
        │         延迟1.5秒后跳转到首页                  │
        └────────────────────┬───────────────────────────┘
                             │
                             ▼
                   ┌──────────────────┐
                   │  pages/index/index.vue │
                   │      首页展示          │
                   └──────────────────┘
```

---

## 🔐 后续请求自动携带 Token

```
┌─────────────────────────────────────────────────────────────┐
│              前端发起任何 API 请求                           │
│  例如：http.post('/api/letter/create', {...})              │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │  utils/http.js 自动添加请求头          │
        │  {                                     │
        │    "Content-Type": "application/json", │
        │    "Authorization": "Bearer token..."  │ ← 自动从本地存储读取
        │  }                                     │
        └───────────────────┬───────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │       发送到后端服务器                 │
        │  POST {baseURL}/api/letter/create     │
        └───────────────────┬───────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │      后端验证 Token                    │
        │  ✓ Token 有效 → 处理请求               │
        │  ✗ Token 无效 → 返回 401 未授权        │
        └───────────────────┬───────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
            Token有效                Token无效/过期
                │                       │
                ▼                       ▼
    ┌───────────────────┐   ┌──────────────────────┐
    │  返回业务数据      │   │  前端自动处理：        │
    │  {                │   │  1. 清除本地登录信息   │
    │    success: true, │   │  2. 提示"登录已过期"   │
    │    data: {...}    │   │  3. 跳转到登录页       │
    │  }                │   └──────────────────────┘
    └───────────────────┘
```

---

## 📊 数据流向图

```
┌──────────┐        ┌──────────┐        ┌──────────┐        ┌──────────┐
│          │  code  │          │  code  │          │ openid │          │
│  前端    ├───────>│ 微信服务器├───────>│  后端    ├───────>│  前端    │
│  小程序  │        │          │ 验证   │  服务器  │ token  │  小程序  │
│          │<───────┤          │<───────┤          │<───────┤          │
└──────────┘ 返回   └──────────┘ 返回   └──────────┘ 保存   └──────────┘
             用户                        session             登录
             信息                        key+openid          状态
```

---

## 🗂️ 文件调用关系

```
pages/login/index.vue                 ← 用户点击登录按钮
         │
         ├─> getWxLoginCode()          ← 调用 uni.login() 获取 code
         │
         ├─> getUserProfile()          ← 调用 uni.getUserProfile() 获取用户信息
         │
         └─> sendLoginToBackend()      ← 发送到后端
                    │
                    ▼
            api/login.js
            wxLogin(code, userInfo)    ← 调用封装的登录API
                    │
                    ▼
            utils/http.js
            http.post(url, data)       ← HTTP请求封装
                    │
                    ├─> 读取 utils/config.js    ← 获取后端地址
                    │
                    ├─> 读取本地存储              ← 获取 token
                    │
                    └─> uni.request()           ← 发送网络请求
                              │
                              ▼
                        后端服务器
                    /api/login/wechat
```

---

## 🔑 Token 使用流程

```
┌─────────────────────────────────────────────────────────────┐
│                   Token 完整生命周期                          │
└─────────────────────────────────────────────────────────────┘

【1. 生成】后端生成 JWT Token
   ↓
【2. 返回】后端返回给前端
   ↓
【3. 保存】前端保存到本地存储
   ↓
   uni.setStorageSync('login_info', {
     token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
     openid: "oABC123xyz...",
     ...
   })
   ↓
【4. 读取】每次请求时自动读取
   ↓
   const loginInfo = uni.getStorageSync('login_info');
   ↓
【5. 携带】自动添加到请求头
   ↓
   headers: {
     "Authorization": "Bearer eyJhbGciOiJIUzI1..."
   }
   ↓
【6. 验证】后端验证 Token
   ↓
   ┌─────────────────┬─────────────────┐
   │   Token 有效    │   Token 无效    │
   │   继续处理      │   返回 401      │
   └─────────────────┴─────────────────┘
                      │
                      ▼
            【7. 过期处理】前端自动清除并跳转登录页
```

---

## 📝 关键代码位置

| 功能 | 文件位置 | 关键代码 |
|------|---------|---------|
| 获取 code | `pages/login/index.vue` | `uni.login()` |
| 获取用户信息 | `pages/login/index.vue` | `uni.getUserProfile()` |
| 发送登录请求 | `api/login.js` | `wxLogin(code, userInfo)` |
| HTTP 封装 | `utils/http.js` | `http.post()` |
| Token 携带 | `utils/http.js` | `header.Authorization` |
| 保存登录状态 | `pages/login/index.vue` | `uni.setStorageSync('login_info', ...)` |
| 配置后端地址 | `utils/config.js` | `baseURL` |

---

## 🔍 调试检查点

### 前端调试

1. **检查 code 是否获取成功**
   ```javascript
   console.log('获取到登录凭证 code:', loginCode);
   ```

2. **检查用户信息是否获取成功**
   ```javascript
   console.log('获取到用户信息:', userProfile);
   ```

3. **检查请求是否发送成功**
   ```javascript
   // 在 utils/http.js 中查看
   console.log('请求成功:', url, res);
   ```

4. **检查 token 是否保存成功**
   ```javascript
   const loginInfo = uni.getStorageSync('login_info');
   console.log('保存的登录信息:', loginInfo);
   ```

### 后端调试

1. **检查是否接收到请求**
   ```javascript
   console.log('接收到登录请求:', req.body);
   ```

2. **检查 code 是否有效**
   ```javascript
   console.log('微信返回:', wxResponse.data);
   ```

3. **检查 token 是否生成**
   ```javascript
   console.log('生成的 token:', token);
   ```

---

## ⚡ 快速定位问题

| 问题 | 可能原因 | 检查位置 |
|------|---------|---------|
| 无法获取 code | 小程序配置错误 | `manifest.json` 中的 AppID |
| 授权弹窗不显示 | 接口调用错误 | `uni.getUserProfile()` 调用 |
| 请求发送失败 | 后端地址错误 | `utils/config.js` 中的 baseURL |
| token 未携带 | 保存失败 | 本地存储 `login_info` |
| 401 未授权 | token 过期 | 检查 token 有效期 |

---

## 📖 相关文档

- 📄 [前端登录功能说明.md](./前端登录功能说明.md) - 详细的代码实现说明
- 📄 [BACKEND_API.md](./BACKEND_API.md) - 后端接口对接文档
- 📄 [LOGIN_README.md](./LOGIN_README.md) - 快速上手指南

---

**文档版本**: 1.0  
**最后更新**: 2025-10-28  
**适用于**: uni-app + 微信小程序
