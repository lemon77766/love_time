# ç™»å½•ä¸ç»‘å®šå…³ç³»åç«¯æ¥å£æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
- **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-XX  
- **é€‚ç”¨æ¨¡å—**ï¼šç”¨æˆ·ç™»å½•ã€æƒ…ä¾£å…³ç³»ç»‘å®š  
- **åŸºç¡€ URL**ï¼š`https://api.love_time.com/api`ï¼ˆè¯·æŒ‰ç¯å¢ƒæ›¿æ¢ä¸ºå¯¹åº” `baseURL`ï¼‰

---

## ğŸ” è®¤è¯è¯´æ˜

- ç™»å½•æ¥å£ï¼ˆ`POST /api/login/wechat`ï¼‰æ— éœ€æºå¸¦ `Authorization` å¤´ã€‚
- å…¶ä»–æ¥å£å‡éœ€åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ `Authorization: Bearer {token}`ã€‚
- `token` ä¸ºç™»å½•æ¥å£æˆåŠŸåè¿”å›çš„ JWT å‡­è¯ã€‚

---

## ğŸ§¾ ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {} | [] | null,
  "errorCode": "å¯é€‰çš„ä¸šåŠ¡é”™è¯¯ç "
}
```

| HTTP çŠ¶æ€ç  | è¯´æ˜                     |
|-------------|--------------------------|
| 200         | è¯·æ±‚æˆåŠŸ                 |
| 400         | å‚æ•°é”™è¯¯ / ä¸šåŠ¡æ ¡éªŒå¤±è´¥ |
| 401         | æœªæˆæƒæˆ– token å¤±æ•ˆ      |
| 404         | èµ„æºä¸å­˜åœ¨               |
| 500         | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯           |

---

## ğŸ’¾ æœ¬åœ°å­˜å‚¨çº¦å®š

- ç™»å½•æˆåŠŸåï¼Œå‰ç«¯ä¼šä»¥ `login_info` çš„é”®å°†ç™»å½•ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ° Storageï¼Œåç»­è¯·æ±‚è‡ªåŠ¨æºå¸¦ tokenã€‚
- æƒ…ä¾£ç»‘å®šä¿¡æ¯å¯ç¼“å­˜åœ¨ `couple_info`ï¼Œç”¨äºå¿«é€Ÿæ¸²æŸ“é¡µé¢ã€‚

ç¤ºä¾‹ï¼š

```json
{
  "token": "JWT_TOKEN",
  "openid": "oABC123xyz...",
  "session_key": "HyVFkGl5F5...",
  "userId": "user_12345",
  "userInfo": {
    "nickName": "æ˜µç§°",
    "avatarUrl": "https://..."
  }
}
```

---

## 1. ç™»å½•è®¤è¯æ¨¡å—

### 1.1 å¾®ä¿¡ç™»å½•

- **æ¥å£**ï¼š`POST /api/login/wechat`
- **åŠŸèƒ½**ï¼šæ¥æ”¶å¾®ä¿¡ `code` + ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼Œå®Œæˆé‰´æƒå¹¶è¿”å› JWT tokenã€‚

**è¯·æ±‚å¤´**
```
Content-Type: application/json
```

**è¯·æ±‚ä½“**
```json
{
  "code": "081xYz0w3wkTiw2TID1w3BW8Jd0xYz0f",
  "nickName": "å°æ‹",
  "avatarUrl": "https://wx.qlogo.cn/mmopen/xxx"
}
```

| å­—æ®µ       | ç±»å‹   | å¿…å¡« | è¯´æ˜                          |
|------------|--------|------|-------------------------------|
| code       | string | âœ…   | `wx.login()` è¿”å›çš„ä¸´æ—¶å‡­è¯   |
| nickName   | string | âœ…   | ç”¨æˆ·æ˜µç§°                      |
| avatarUrl  | string | âœ…   | ç”¨æˆ·å¤´åƒ URL                  |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "openid": "oABC123xyz...",
    "session_key": "HyVFkGl5F5...",
    "userId": "user_12345",
    "isNewUser": false
  }
}
```

**åç«¯å¤„ç†è¦ç‚¹**
1. è°ƒç”¨ `https://api.weixin.qq.com/sns/jscode2session` æ ¡éªŒ `code`ã€‚
2. æ ¹æ® `openid` æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·ã€‚
3. ç”Ÿæˆ JWTï¼ˆPayload è‡³å°‘åŒ…å« `userId` / `openid`ï¼‰ã€‚
4. è¿”å› token åŠä¼šè¯ä¿¡æ¯ã€‚

---

### 1.2 é€€å‡ºç™»å½•

- **æ¥å£**ï¼š`POST /api/login/logout`
- **åŠŸèƒ½**ï¼šæœåŠ¡ç«¯å¯é€‰å®ç°ã€‚å‰ç«¯ä¼šæ¸…é™¤æœ¬åœ° `login_info`ï¼Œè‹¥æœåŠ¡ç«¯ç»´æŠ¤ sessionï¼Œå¯åŒæ—¶å¤±æ•ˆ tokenã€‚

**è¯·æ±‚ä½“**ï¼šæ— 

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "é€€å‡ºæˆåŠŸ"
}
```

---

### 1.3 è·å–ç”¨æˆ·ä¿¡æ¯

- **æ¥å£**ï¼š`GET /api/user/info`
- **åŠŸèƒ½**ï¼šæ ¹æ® token è¿”å›å½“å‰ç™»å½•ç”¨æˆ·èµ„æ–™ã€‚

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "userId": "user_12345",
    "nickName": "å°æ‹",
    "avatarUrl": "https://.../avatar.png",
    "gender": 2,
    "city": "æ·±åœ³",
    "phone": "138****8888",
    "bindStatus": {
      "isBound": true,
      "coupleId": "couple_001"
    }
  }
}
```

---

## 2. æƒ…ä¾£å…³ç³»ç»‘å®šæ¨¡å—

### 2.1 ç”Ÿæˆé‚€è¯·ç 

- **æ¥å£**ï¼š`POST /api/couple/invite/create`
- **åŠŸèƒ½**ï¼šç»‘å®šå‘èµ·æ–¹ç”Ÿæˆ 6 ä½é‚€è¯·ç ï¼Œæœ‰æ•ˆæœŸé»˜è®¤ 24 å°æ—¶ã€‚

**è¯·æ±‚ä½“ï¼ˆå¯é€‰ï¼‰**
```json
{
  "userId": "user_12345"
}
```
> å¦‚æœªä¼  `userId`ï¼Œåç«¯éœ€æ ¹æ® token è§£æã€‚

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "é‚€è¯·ç ç”ŸæˆæˆåŠŸ",
  "data": {
    "inviteCode": "U9441L",
    "expireAt": "2025-01-16T10:30:00Z",
    "isBound": false
  }
}
```

**ä¸šåŠ¡è§„åˆ™**
- å·²ç»‘å®šç”¨æˆ·ç¦æ­¢å†æ¬¡ç”Ÿæˆé‚€è¯·ç ã€‚
- é‚€è¯·ç éœ€ä¸å‘èµ·äºº IDã€æœ‰æ•ˆæœŸä¸€å¹¶è½åº“ã€‚

---

### 2.2 éªŒè¯é‚€è¯·ç 

- **æ¥å£**ï¼š`GET /api/couple/invite/validate?code=U9441L`
- **åŠŸèƒ½**ï¼šå—é‚€æ–¹è¾“å…¥é‚€è¯·ç åï¼ŒæŸ¥è¯¢å…¶æœ‰æ•ˆæ€§ä¸å‘èµ·æ–¹èµ„æ–™ã€‚

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "é‚€è¯·ç æœ‰æ•ˆ",
  "data": {
    "code": "U9441L",
    "creator": {
      "userId": "user_12345",
      "nickName": "å°æ‹",
      "avatarUrl": "https://.../avatar.png"
    },
    "expireAt": "2025-01-16T10:30:00Z"
  }
}
```

**é”™è¯¯ç¤ºä¾‹**
```json
{
  "success": false,
  "message": "é‚€è¯·ç å·²è¿‡æœŸ",
  "errorCode": "INVITE_CODE_EXPIRED"
}
```

---

### 2.3 æ¥å—é‚€è¯· / å»ºç«‹å…³ç³»

- **æ¥å£**ï¼š`POST /api/couple/bind/accept`
- **åŠŸèƒ½**ï¼šå—é‚€æ–¹æäº¤é‚€è¯·ç ï¼Œç³»ç»Ÿä¸ºåŒæ–¹åˆ›å»ºæƒ…ä¾£å…³ç³»ã€‚

**è¯·æ±‚ä½“**
```json
{
  "inviteCode": "U9441L",
  "userId": "user_67890"
}
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "ç»‘å®šæˆåŠŸ",
  "data": {
    "coupleId": "couple_001",
    "partnerInfo": {
      "userId": "user_12345",
      "nickName": "å°æ‹",
      "avatarUrl": "https://.../avatar.png"
    },
    "bindTime": "2025-01-15T11:00:00Z",
    "role": "accepter"
  }
}
```

**ä¸šåŠ¡æ ¡éªŒ**
1. é‚€è¯·ç æ˜¯å¦å­˜åœ¨ä¸”æœªè¿‡æœŸã€‚
2. å‘èµ·æ–¹ã€å—é‚€æ–¹å‡éœ€å¤„äºæœªç»‘å®šçŠ¶æ€ã€‚
3. åŒä¸€é‚€è¯·ç ä»…å¯ä½¿ç”¨ä¸€æ¬¡ã€‚

---

### 2.4 æŸ¥è¯¢ç»‘å®šçŠ¶æ€

- **æ¥å£**ï¼š`GET /api/couple/status`
- **åŠŸèƒ½**ï¼šæŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ·çš„æƒ…ä¾£å…³ç³»ä¿¡æ¯ã€‚

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "isBound": true,
    "coupleId": "couple_001",
    "partnerInfo": {
      "userId": "user_12345",
      "nickName": "å°æ‹",
      "avatarUrl": "https://.../avatar.png"
    },
    "bindTime": "2025-01-15T11:00:00Z",
    "role": "initiator"
  }
}
```

**æœªç»‘å®šè¿”å›**
```json
{
  "success": true,
  "data": {
    "isBound": false
  },
  "message": "æœªæ‰¾åˆ°æƒ…ä¾£å…³ç³»"
}
```

---

### 2.5 è§£ç»‘å…³ç³»

- **æ¥å£**ï¼š`POST /api/couple/unbind`
- **åŠŸèƒ½**ï¼šè§£é™¤æƒ…ä¾£å…³ç³»ï¼ˆéœ€åŒå‘è§£é™¤æˆ–é»˜è®¤å•æ–¹å³å¯ï¼‰ã€‚

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "è§£ç»‘æˆåŠŸ"
}
```

**ä¸šåŠ¡å»ºè®®**
- è§£ç»‘è®°å½•éœ€è½åº“ï¼ˆ`couple_unbind_logs`ï¼‰ï¼Œæ–¹ä¾¿è¿½æº¯ã€‚
- å¯ä»¥é€‰æ‹©é€šçŸ¥å¯¹æ–¹æˆ–è¦æ±‚åŒæ–¹ç¡®è®¤ã€‚

---

### 2.6 è·å–ç›¸çˆ±å¤©æ•°

- **æ¥å£**ï¼š`GET /api/couple/love-days`
- **åŠŸèƒ½**ï¼šè¿”å›ç»‘å®šåçš„æ‹çˆ±å¤©æ•°ã€çºªå¿µæ—¥ç­‰ä¿¡æ¯ï¼Œç”¨äºé¦–é¡µå±•ç¤ºã€‚

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "loveDays": 150,
    "anniversaryDate": "2024-09-18",
    "relationshipName": "æˆ‘çš„å®è´"
  }
}
```

**è¯´æ˜**
- `loveDays = floor((now - bindTime) / 86400)`
- `anniversaryDate` è‹¥æœªè®¾ç½®å¯è¿”å›é»˜è®¤å€¼æˆ– `null`

---

## 3. å…¸å‹ä¸šåŠ¡æµç¨‹

### 3.1 ç™»å½•æµç¨‹ï¼ˆå°ç¨‹åºç«¯ï¼‰

1. è°ƒç”¨ `wx.login()` è·å– `code`  
2. è°ƒç”¨ `uni.getUserProfile()` è·å–æ˜µç§° & å¤´åƒ  
3. å‰ç«¯ `POST /api/login/wechat`  
4. æœåŠ¡ç«¯æ ¡éªŒ `code` â†’ è¿”å› `token + openid + userId`  
5. å‰ç«¯ç¼“å­˜ `login_info` â†’ è·³è½¬é¦–é¡µ

### 3.2 æƒ…ä¾£ç»‘å®šæµç¨‹

```
ç”¨æˆ·Aï¼ˆå‘èµ·æ–¹ï¼‰                   ç”¨æˆ·Bï¼ˆå—é‚€æ–¹ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. POST /invite/create â†’ code
                               2. è¾“å…¥é‚€è¯·ç  â†’ GET /invite/validate
                               3. ç¡®è®¤ç»‘å®š â†’ POST /bind/accept
4. åŒæ–¹ GET /status â†’ isBound = true
```

---

## 4. æ•°æ®åº“è®¾è®¡å»ºè®®

### 4.1 ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  openid VARCHAR(64) UNIQUE NOT NULL,
  nick_name VARCHAR(50) NOT NULL,
  avatar_url VARCHAR(255),
  gender TINYINT,
  city VARCHAR(50),
  phone VARCHAR(20),
  session_key VARCHAR(64),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 4.2 æƒ…ä¾£å…³ç³»è¡¨ï¼ˆcouplesï¼‰

```sql
CREATE TABLE couples (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  couple_id VARCHAR(32) UNIQUE NOT NULL,
  initiator_id BIGINT NOT NULL,
  accepter_id BIGINT NOT NULL,
  bind_time DATETIME NOT NULL,
  status ENUM('active','unbound') DEFAULT 'active',
  anniversary_date DATE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_initiator (initiator_id),
  INDEX idx_accepter (accepter_id)
);
```

### 4.3 é‚€è¯·ç è¡¨ï¼ˆcouple_invitesï¼‰

```sql
CREATE TABLE couple_invites (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  invite_code CHAR(6) UNIQUE NOT NULL,
  creator_id BIGINT NOT NULL,
  expire_at DATETIME NOT NULL,
  status ENUM('unused','used','expired') DEFAULT 'unused',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  used_at DATETIME,
  INDEX idx_creator (creator_id)
);
```

---

## 5. æµ‹è¯•ä¸è”è°ƒå»ºè®®

| åœºæ™¯                         | è¯´æ˜                                                         |
|------------------------------|--------------------------------------------------------------|
| ç™»å½•æˆåŠŸ / code è¿‡æœŸ         | æ¨¡æ‹Ÿæ­£ç¡®ä¸è¿‡æœŸ `code`ï¼ŒéªŒè¯åç«¯é”™è¯¯å¤„ç†                     |
| é‡å¤ç™»å½•                     | åŒä¸€ç”¨æˆ·å¤šæ¬¡ç™»å½•ï¼Œç¡®è®¤ token åˆ·æ–°ç­–ç•¥                       |
| ç”Ÿæˆé‚€è¯·ç ï¼ˆå·²ç»‘å®šç”¨æˆ·ï¼‰     | å·²ç»‘å®šç”¨æˆ·å°è¯•å†æ¬¡ç”Ÿæˆé‚€è¯·ç ï¼Œåº”è¿”å›æ˜ç¡®é”™è¯¯                |
| é‚€è¯·ç è¿‡æœŸ / æ— æ•ˆ            | éªŒè¯è¿”å› `INVITE_CODE_EXPIRED` / `INVITE_CODE_INVALID`      |
| é‡å¤ç»‘å®š                     | åŒä¸€å¡å·äºŒæ¬¡ç»‘å®šéœ€æ‹¦æˆªï¼ˆæ— è®ºä½¿ç”¨åŒé‚€è¯·ç è¿˜æ˜¯ä¸åŒé‚€è¯·ç ï¼‰    |
| è§£ç»‘åå†æ¬¡ç»‘å®š               | ç¡®è®¤è§£ç»‘æµç¨‹ä¸ç¼“å­˜æ¸…ç†æ˜¯å¦æ­£å¸¸                               |
| love-days è®¡ç®—               | ç»‘å®šå½“å¤©ã€è·¨å¤©ã€å¤šå¹´ç­‰åœºæ™¯çš„å¤©æ•°è®¡ç®—æ­£ç¡®æ€§                   |
| token å¤±æ•ˆ                   | æ‰‹åŠ¨è®© token å¤±æ•ˆï¼Œç¡®è®¤æ‰€æœ‰æ¥å£è¿”å› 401 å¹¶æç¤ºé‡æ–°ç™»å½•       |

---

## 6. å¸¸è§é”™è¯¯ç å»ºè®®

| errorCode                | æè¿°                         |
|--------------------------|------------------------------|
| `LOGIN_CODE_INVALID`     | å¾®ä¿¡ `code` æ— æ•ˆ             |
| `LOGIN_CODE_EXPIRED`     | å¾®ä¿¡ `code` è¿‡æœŸ             |
| `INVITE_CODE_INVALID`    | é‚€è¯·ç ä¸å­˜åœ¨                 |
| `INVITE_CODE_EXPIRED`    | é‚€è¯·ç è¿‡æœŸ                   |
| `ALREADY_BOUND`          | ç”¨æˆ·å·²ç»‘å®š                   |
| `INVITER_ALREADY_BOUND`  | å‘èµ·æ–¹å·²ç»‘å®š                 |
| `INVITEE_ALREADY_BOUND`  | å—é‚€æ–¹å·²ç»‘å®š                 |
| `RELATION_NOT_FOUND`     | æœªæ‰¾åˆ°æƒ…ä¾£å…³ç³»               |
| `RELATION_ALREADY_UNBOUND` | æƒ…ä¾£å…³ç³»å·²è§£ç»‘            |

---

## 7. å‚è€ƒèµ„æ–™

- å¾®ä¿¡å®˜æ–¹ç™»å½•æµç¨‹æ–‡æ¡£  
- é¡¹ç›®å†… `LOGIN_README.md`ã€`BACKEND_API.md`  
- å‰ç«¯ API å°è£…ï¼š`api/login.js`ã€`api/couple.js`

---

**æ–‡æ¡£ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**ï¼š2025-01-XX


