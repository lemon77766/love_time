# 历史轨迹查询功能 - 实现总结

## ✅ 前端已完成

前端已实现以下功能，**无需额外开发**：

1. ✅ **时间区间选择器**
   - 开始日期和结束日期选择器
   - 日期格式验证（开始日期不能晚于结束日期）
   
2. ✅ **历史轨迹查询**
   - 根据选择的时间区间调用API查询轨迹点
   - 加载状态提示
   - 错误处理和提示

3. ✅ **地图显示**
   - 历史轨迹点在地图上显示为标记点
   - 轨迹点按时间顺序自动连线
   - 自动计算地图中心点和缩放级别

4. ✅ **轨迹点详情**
   - 点击地图标记点查看详情
   - 显示地点名称、地址、访问时间
   - 显示描述、照片、到访次数等元数据

5. ✅ **清除功能**
   - 清除历史轨迹，恢复实时位置显示

---

## 🔧 前端还需做什么

**前端无需额外开发**，所有功能已实现完成。

只需要：
- 等待后端接口对接
- 测试功能是否正常工作

---

## 🔌 后端需要实现的接口

### **核心接口：获取历史轨迹点列表**

**接口信息**：
- **请求方法**: `GET`
- **请求地址**: `/api/trajectory/points`
- **请求头**: 需携带 `Authorization: Bearer {token}`

**新增请求参数**（与现有的 `period` 参数二选一）：
```
start_date=2024-01-01    // 开始日期（格式：YYYY-MM-DD）
end_date=2024-01-31      // 结束日期（格式：YYYY-MM-DD）
limit=1000               // 每页数量（可选，默认50，建议支持最大1000）
```

**返回数据格式**：
```json
{
  "success": true,
  "data": {
    "points": [
      {
        "id": 123,
        "user_id": 1,
        "latitude": 39.9042,
        "longitude": 116.4074,
        "address": "北京市朝阳区xxx街道",
        "location_name": "初遇咖啡厅",
        "visit_time": "2024-01-15T10:30:00.000Z",  // ISO时间格式，必填
        "stay_duration": 120,                      // 停留时长（分钟），可选
        "importance_score": 9.5,                  // 重要性评分（0-10），可选
        "visit_count": 1,                          // 到访次数，可选
        "is_manual": false,                        // 是否手动添加，可选
        "description": "第一次见面的地方",          // 描述，可选
        "photos": [                                // 照片列表，可选
          "/path/to/photo1.jpg"
        ]
      }
    ]
  }
}
```

### **关键实现要点**

1. **时间范围查询**：
   - 查询 `visit_time` 在 `[start_date 00:00:00, end_date 23:59:59]` 范围内的轨迹点
   - 必须包含开始日期和结束日期当天的所有轨迹点

2. **数据范围**：
   - 只返回当前用户及其配对用户的轨迹点（双方轨迹点）
   - 如果用户未绑定配对关系，只返回当前用户的轨迹点

3. **排序**：
   - 轨迹点按 `visit_time` 升序排序（时间从早到晚）
   - 前端会根据这个顺序连接轨迹线

4. **必需字段**：
   - 每个轨迹点必须包含：`id`、`user_id`、`latitude`、`longitude`、`visit_time`
   - 建议包含：`address` 或 `location_name`（用于显示地点名称）

5. **参数验证**：
   - 验证 `start_date` 和 `end_date` 格式（YYYY-MM-DD）
   - 验证开始日期不能晚于结束日期
   - 建议限制查询范围（如最多365天）

### **错误处理**

**参数错误**：
```json
{
  "success": false,
  "message": "开始日期不能晚于结束日期",
  "code": "INVALID_PARAMS"
}
```

**无数据**：
```json
{
  "success": true,
  "data": {
    "points": []
  }
}
```

---

## 📚 详细文档

更详细的接口需求文档请查看：`docs/trajectory_history_api_requirements.md`

---

## 🎯 测试建议

后端接口实现后，建议测试以下场景：

1. **正常查询**：选择合理的日期区间，查看是否正常返回轨迹点
2. **单日查询**：开始日期和结束日期相同
3. **参数错误**：开始日期晚于结束日期
4. **无数据**：选择没有轨迹点的日期区间
5. **大数据量**：选择较长时间区间，测试性能

---

## 📞 参考代码

- API调用：`api/trajectory.js` 中的 `getTrajectoryPoints` 函数
- 页面实现：`pages/trajectory/index.vue`

