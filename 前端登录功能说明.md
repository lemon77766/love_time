# 前端微信授权登录功能说明文档

> 本文档详细说明前端小程序的微信授权登录实现，方便与后端开发人员对接。

---

## 📱 一、功能概述

### 实现的功能
✅ 用户点击"微信授权登录"按钮  
✅ 调用微信接口获取临时登录凭证 `code`  
✅ 获取用户信息（昵称、头像）  
✅ 将 `code` 和用户信息发送到后端服务器  
✅ 接收后端返回的 `token`、`openid`、`session_key`  
✅ 保存登录状态和用户信息  
✅ 自动跳转到首页  
✅ 后续请求自动携带 `token`  

---

## 📁 二、文件结构

```
love_time/
├── pages/
│   └── login/
│       └── index.vue                  # 登录页面（主要文件）
├── api/
│   └── login.js                       # 登录API接口封装
├── utils/
│   ├── config.js                      # 配置文件（后端地址）
│   └── http.js                        # HTTP请求封装（自动携带token）
└── BACKEND_API.md                     # 后端对接文档
```

---

## 🔧 三、核心文件说明

### 1. 登录页面 `pages/login/index.vue`

这是用户看到的登录界面，包含完整的登录流程。

#### 关键代码：

```javascript
// ========================================
// 步骤1：用户点击"微信授权登录"按钮
// ========================================
async handleWxLogin() {
  this.isLoading = true;
  
  try {
    // 步骤2：获取微信登录凭证 code
    const loginCode = await this.getWxLoginCode();
    
    // 步骤3：获取用户信息（昵称、头像）
    const userProfile = await this.getUserProfile();
    
    // 步骤4：发送到后端服务器
    const loginResult = await this.sendLoginToBackend(loginCode, userProfile);
    
    // 步骤5：保存登录信息
    uni.setStorageSync('login_info', {
      isLoggedIn: true,
      userInfo: this.userInfo,
      token: loginResult.token,           // 重要：后端返回的token
      openid: loginResult.openid,         // 重要：微信用户唯一标识
      sessionKey: loginResult.session_key,
      loginTime: new Date().toISOString()
    });
    
    // 步骤6：跳转到首页
    this.enterApp();
  } catch (e) {
    console.error('登录失败', e);
  }
}
```

#### 详细说明：

**步骤2：获取微信 code**
```javascript
getWxLoginCode() {
  return new Promise((resolve, reject) => {
    uni.login({
      provider: 'weixin',
      success: (res) => {
        if (res.code) {
          resolve(res.code);  // 这个code要发送给后端
        }
      }
    });
  });
}
```
- 调用微信官方接口 `uni.login()`
- 获取临时登录凭证 `code`（有效期5分钟）
- 这个 `code` 需要发送给后端

**步骤3：获取用户信息**
```javascript
getUserProfile() {
  return new Promise((resolve, reject) => {
    uni.getUserProfile({
      desc: '用于完善用户资料',
      success: (res) => {
        resolve(res.userInfo);  // 包含 nickName、avatarUrl
      }
    });
  });
}
```
- 弹出授权窗口，获取用户同意
- 获取用户的昵称（nickName）和头像（avatarUrl）

**步骤4：发送到后端**
```javascript
async sendLoginToBackend(code, userInfo) {
  // 调用封装好的API
  const result = await wxLogin(code, userInfo);
  return result;  // 返回 { token, openid, session_key }
}
```

---

### 2. API封装 `api/login.js`

封装了所有登录相关的接口调用。

```javascript
import http from '../utils/http.js';
import config from '../utils/config.js';

/**
 * 微信登录接口
 * @param {string} code - 微信登录凭证
 * @param {Object} userInfo - 用户信息 { nickName, avatarUrl }
 * @returns {Promise} 返回 { token, openid, session_key }
 */
export function wxLogin(code, userInfo) {
  return http.post(config.API.LOGIN.WECHAT, {
    code: code,              // 发送给后端的code
    nickName: userInfo.nickName,
    avatarUrl: userInfo.avatarUrl
  });
}
```

**发送给后端的数据格式：**
```json
{
  "code": "081xYz0w3wkTiw2TID1w3BW8Jd0xYz0f",
  "nickName": "微信用户",
  "avatarUrl": "https://thirdwx.qlogo.cn/..."
}
```

**后端应该返回的数据格式：**
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "openid": "oABC123xyz...",
    "session_key": "HyVFkGl5F5...",
    "userId": "user_12345"
  }
}
```

---

### 3. 配置文件 `utils/config.js`

管理后端服务器地址和接口路径。

```javascript
const CONFIG = {
  // 开发环境
  development: {
    baseURL: 'http://localhost:3000',  // ⚠️ 改成你的后端地址
    timeout: 10000
  },
  // 生产环境
  production: {
    baseURL: 'https://your-backend-domain.com',  // ⚠️ 改成正式服务器地址
    timeout: 10000
  }
};

export default {
  baseURL: currentConfig.baseURL,
  
  // 接口路径定义
  API: {
    LOGIN: {
      WECHAT: '/api/login/wechat',  // 微信登录接口
      LOGOUT: '/api/login/logout'
    }
  }
};
```

**🔥 重要：对接时需要修改**
- 开发环境：改成后端的本地地址（如 `http://192.168.1.100:3000`）
- 生产环境：改成正式服务器域名

---

### 4. HTTP封装 `utils/http.js`

统一处理所有HTTP请求，自动携带token。

```javascript
class Http {
  request(options = {}) {
    return new Promise((resolve, reject) => {
      // 自动获取登录信息
      const loginInfo = uni.getStorageSync('login_info') || {};
      
      // 构建请求
      const requestOptions = {
        url: config.baseURL + options.url,  // 完整URL
        method: options.method || 'GET',
        data: options.data || {},
        header: {
          'content-type': 'application/json',
          // ⚠️ 重要：自动携带token
          'Authorization': loginInfo.token ? `Bearer ${loginInfo.token}` : '',
          ...options.header
        }
      };
      
      uni.request({
        ...requestOptions,
        success: (res) => {
          if (res.statusCode === 200) {
            // 业务成功
            if (res.data.success) {
              resolve(res.data.data);
            } else {
              reject(new Error(res.data.message));
            }
          } else if (res.statusCode === 401) {
            // token过期，自动跳转到登录页
            this.handleUnauthorized();
          }
        }
      });
    });
  }
  
  // 处理未授权（token过期）
  handleUnauthorized() {
    uni.removeStorageSync('login_info');
    uni.showToast({ title: '登录已过期', icon: 'none' });
    uni.reLaunch({ url: '/pages/login/index' });
  }
}
```

**关键特性：**
- ✅ 自动携带 token（从本地存储读取）
- ✅ 统一错误处理
- ✅ token过期自动跳转登录页
- ✅ 封装了 GET、POST、PUT、DELETE 方法

---

## 🔄 四、完整登录流程图

```
用户                    前端小程序                  微信服务器              后端服务器
 │                          │                          │                      │
 │  点击"微信授权登录"       │                          │                      │
 ├─────────────────────────>│                          │                      │
 │                          │                          │                      │
 │                          │  1. uni.login()          │                      │
 │                          ├─────────────────────────>│                      │
 │                          │                          │                      │
 │                          │  返回 code (5分钟有效)   │                      │
 │                          │<─────────────────────────┤                      │
 │                          │                          │                      │
 │  弹出授权窗口             │                          │                      │
 │<─────────────────────────┤                          │                      │
 │                          │                          │                      │
 │  用户点击"允许"           │                          │                      │
 ├─────────────────────────>│                          │                      │
 │                          │                          │                      │
 │                          │  2. uni.getUserProfile() │                      │
 │                          │  获取昵称、头像           │                      │
 │                          │                          │                      │
 │                          │  3. POST /api/login/wechat                      │
 │                          │  发送: code + userInfo   │                      │
 │                          ├───────────────────────────────────────────────>│
 │                          │                          │                      │
 │                          │                          │  后端用code换取openid │
 │                          │                          │<─────────────────────┤
 │                          │                          │                      │
 │                          │                          │  返回openid+session  │
 │                          │                          ├─────────────────────>│
 │                          │                          │                      │
 │                          │  4. 返回 token + openid  │                      │
 │                          │<───────────────────────────────────────────────┤
 │                          │                          │                      │
 │                          │  5. 保存到本地存储        │                      │
 │                          │  - token                 │                      │
 │                          │  - openid                │                      │
 │                          │  - userInfo              │                      │
 │                          │                          │                      │
 │  跳转到首页               │                          │                      │
 │<─────────────────────────┤                          │                      │
 │                          │                          │                      │
```

---

## 📊 五、数据流说明

### 发送给后端的数据

**接口地址：** `POST {baseURL}/api/login/wechat`

**请求体：**
```json
{
  "code": "081xYz0w3wkTiw2TID1w3BW8Jd0xYz0f",  // 微信临时登录凭证
  "nickName": "微信用户",                      // 用户昵称
  "avatarUrl": "https://thirdwx.qlogo.cn/..."  // 用户头像
}
```

### 后端应该返回的数据

**成功响应：**
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",  // JWT token
    "openid": "oABC123xyz...",                           // 微信openid
    "session_key": "HyVFkGl5F5...",                      // 会话密钥
    "userId": "user_12345",                              // 用户ID（可选）
    "isNewUser": false                                   // 是否新用户（可选）
  }
}
```

**失败响应：**
```json
{
  "success": false,
  "message": "登录失败：code已过期",
  "data": null
}
```

---

## 🔑 六、Token 使用说明

### Token 的保存

登录成功后，前端会自动保存token到本地存储：

```javascript
uni.setStorageSync('login_info', {
  isLoggedIn: true,
  token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  openid: 'oABC123xyz...',
  userInfo: { nickName: '...', avatarUrl: '...' }
});
```

### Token 的自动携带

所有后续的API请求都会自动携带token：

```javascript
// 示例：创建信件
import http from '@/utils/http.js';

const data = await http.post('/api/letter/create', {
  title: '信件标题',
  content: '信件内容'
});

// 实际发送的请求头中会自动包含：
// Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Token 过期处理

当后端返回 401 状态码时，前端会自动：
1. 清除本地登录信息
2. 提示"登录已过期"
3. 跳转到登录页

---

## 🛠️ 七、后端需要做什么

### 1. 接收前端请求

```javascript
// Node.js + Express 示例
app.post('/api/login/wechat', async (req, res) => {
  const { code, nickName, avatarUrl } = req.body;
  
  // 验证参数
  if (!code) {
    return res.json({
      success: false,
      message: '缺少code参数'
    });
  }
  
  // 继续处理...
});
```

### 2. 调用微信服务器

```javascript
const axios = require('axios');

// 微信接口地址
const WX_API = 'https://api.weixin.qq.com/sns/jscode2session';

// 小程序配置（从微信公众平台获取）
const APPID = 'wxXXXXXXXX';        // ⚠️ 需要配置
const SECRET = 'your_app_secret';  // ⚠️ 需要配置

// 用code换取openid和session_key
const response = await axios.get(WX_API, {
  params: {
    appid: APPID,
    secret: SECRET,
    js_code: code,
    grant_type: 'authorization_code'
  }
});

const { openid, session_key } = response.data;
```

### 3. 生成 JWT Token

```javascript
const jwt = require('jsonwebtoken');

// 生成token
const token = jwt.sign(
  { 
    userId: user.id, 
    openid: openid 
  },
  'your_secret_key',  // ⚠️ 需要配置密钥
  { expiresIn: '7d' }  // 有效期7天
);
```

### 4. 返回结果给前端

```javascript
res.json({
  success: true,
  message: '登录成功',
  data: {
    token: token,
    openid: openid,
    session_key: session_key,
    userId: user.id
  }
});
```

---

## ⚙️ 八、前后端对接步骤

### 第一步：后端准备

1. ✅ 创建登录接口 `POST /api/login/wechat`
2. ✅ 配置小程序 AppID 和 AppSecret（从微信公众平台获取）
3. ✅ 实现微信登录验证逻辑
4. ✅ 返回统一格式的JSON响应

### 第二步：前端配置

1. ✅ 修改 `utils/config.js` 中的 `baseURL`
   ```javascript
   development: {
     baseURL: 'http://192.168.1.100:3000'  // 改成后端地址
   }
   ```

2. ✅ 确认接口路径一致
   - 前端：`/api/login/wechat`
   - 后端：`/api/login/wechat`

### 第三步：联调测试

1. ✅ 启动后端服务器
2. ✅ 启动前端小程序（开发者工具）
3. ✅ 点击"微信授权登录"
4. ✅ 查看控制台输出：
   - code（前端获取）
   - 请求参数（发送给后端）
   - 响应结果（后端返回）
5. ✅ 确认登录成功并跳转

### 第四步：验证功能

- ✅ 登录状态是否保存
- ✅ 刷新后是否仍然登录
- ✅ Token是否自动携带
- ✅ Token过期是否正确跳转

---

## 🐛 九、常见问题

### Q1: code 是什么？有效期多久？

**A:** 
- `code` 是微信服务器返回的临时登录凭证
- 有效期只有 **5分钟**
- 每次调用 `uni.login()` 都会生成新的code
- code只能使用一次

### Q2: 为什么需要 code？

**A:** 
- 前端无法直接获取 `openid`（微信用户唯一标识）
- 需要通过后端用 `code` + `AppSecret` 向微信服务器换取
- 这样保证了 `AppSecret` 的安全性

### Q3: token 存储在哪里？

**A:**
```javascript
// 保存
uni.setStorageSync('login_info', { token: '...' });

// 读取
const loginInfo = uni.getStorageSync('login_info');
console.log(loginInfo.token);

// 清除
uni.removeStorageSync('login_info');
```

### Q4: 如何测试（后端未就绪）？

**A:** 
- 前端有开发模式，会自动使用模拟数据
- 可以先完成前端页面开发
- 等后端就绪后再对接

### Q5: 如何查看请求日志？

**A:**
```javascript
// 在 utils/http.js 中已添加日志
console.log('请求成功:', url, res);
console.error('请求失败:', url, err);
```

打开微信开发者工具控制台即可查看。

---

## 📝 十、代码检查清单

### 前端检查项

- [ ] `utils/config.js` 的 `baseURL` 已修改为后端地址
- [ ] `pages/login/index.vue` 登录流程完整
- [ ] `api/login.js` 接口封装正确
- [ ] `utils/http.js` 请求拦截器配置正确
- [ ] 本地存储 `login_info` 格式正确

### 后端检查项

- [ ] 接口地址 `/api/login/wechat` 已创建
- [ ] 接收参数：`code`, `nickName`, `avatarUrl`
- [ ] 调用微信接口换取 `openid` 和 `session_key`
- [ ] 生成并返回 JWT `token`
- [ ] 返回格式符合约定（`{ success, message, data }`）

---

## 📞 十一、技术支持

### 查看完整后端对接文档

详细的接口定义和示例代码请查看：
📄 `BACKEND_API.md`

### 调试建议

1. **查看网络请求**
   - 微信开发者工具 → Network 标签
   - 查看请求地址、参数、响应

2. **查看控制台日志**
   - Console 标签
   - 查看 `console.log` 输出

3. **查看本地存储**
   - Storage 标签
   - 查看 `login_info` 的值

---

## 📄 十二、相关文件

| 文件路径 | 说明 |
|---------|------|
| `pages/login/index.vue` | 登录页面（主要逻辑） |
| `api/login.js` | 登录API封装 |
| `utils/config.js` | 配置文件（后端地址） |
| `utils/http.js` | HTTP请求封装 |
| `BACKEND_API.md` | 后端对接文档 |

---

## ✅ 总结

### 前端已完成的功能

✅ 微信授权登录界面  
✅ 获取微信 code  
✅ 获取用户信息（昵称、头像）  
✅ 发送 code 到后端  
✅ 接收并保存 token  
✅ 自动携带 token 发送请求  
✅ Token 过期自动跳转登录  
✅ 完整的错误处理  

### 需要后端配合的内容

⚠️ 创建 `/api/login/wechat` 接口  
⚠️ 配置小程序 AppID 和 AppSecret  
⚠️ 调用微信服务器验证 code  
⚠️ 生成并返回 JWT token  
⚠️ 返回统一的 JSON 格式  

### 对接时只需要

1️⃣ 修改 `utils/config.js` 中的后端地址  
2️⃣ 启动前后端服务进行联调  
3️⃣ 测试登录流程是否正常  

---

**文档编写时间：** 2025-10-28  
**前端框架：** uni-app (Vue 3)  
**小程序平台：** 微信小程序
